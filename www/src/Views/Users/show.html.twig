{% extends 'Layouts/main.html.twig' %}

{% block content %}
    <div id="app">
        <div class="sticky top-0 px-4 bg-neutral-900 p-3 z-50">
            <label class="font-bold inline-block py-2" for="searchBox">search</label>
            <input type="text" id="searchBox" v-model="searchBox" class="rounded" /><br>

            <input type="checkbox" value="wip" id="listMode2" v-model="listMode" class="hidden mr-2 peer/a1" />
            <label for="listMode2" class="peer-checked/a1:text-sky-500 inline-block bg-neutral-500 peer-checked/a1:bg-sky-900 py-1 px-2 rounded mr-2">WIP</label>

            <input type="checkbox" value="completed" id="listMode1" v-model="listMode" class="hidden mr-2 peer/a2" />
            <label for="listMode1" class="peer-checked/a2:text-sky-500 inline-block bg-neutral-500 peer-checked/a2:bg-sky-900 py-1 px-2 rounded mr-2">100%</label>

            <input type="checkbox" value="none" id="listMode3" v-model="listMode" class="hidden mr-2 peer/a3" />
            <label for="listMode3" class="peer-checked/a3:text-sky-500 inline-block bg-neutral-500 peer-checked/a3:bg-sky-900 py-1 px-2 rounded">0%</label>
        </div>
        <div class="my-3">
            <a href="#" class="inline-block px-2 py-1 rounded bg-neutral-600">Games</a>
            <a href="/users/activity.php?{{ {'userid': user.id}|url_encode }}" class="inline-block px-2 py-1 rounded bg-neutral-800">Activity</a>
        </div>
        {% verbatim %}
            <h2>{{ games.length }} Games</h2>
            <div class="grid md:grid-cols-4 grid-cols-1 gap-2">
                    <div v-for="game in games">
                        <a :href="'/games/user.php?gameid=' + game.id + '&userid=' + userId" class="flex">
                            <div :style="{ backgroundColor: 'hsl(' + Math.floor(game.achievement_percent) + ', 50%, 35%)' }" class="w-2 shrink-0"></div>
                            <div class="p-2 bg-neutral-800 grow">
                                <div class="line-clamp-1 text-white">
                                    <span v-html="highlight(game.name)"></span> <small v-if="!!game.completed_at"><i class="fa-solid fa-crown text-yellow-400"></i> {{ game.completed_at }}</small>
                                </div>
                                <div class="flex justify-between">
                                    <span class="truncate"><i class="fa-solid fa-trophy"></i> {{ game.unlocked_achievements }}/{{ game.total_achievements }}</span>
                                    <span>{{ game.achievement_percent }} <i class="fa-solid fa-percent"></i></span>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        {% endverbatim %}
        <script>
        const {createApp, ref, computed} = Vue

        createApp({
            setup() {
                const listMode = ref(['wip']) // wip, completed, none
                const searchBox = ref('')
                const userId = '{{ user.id }}'

                const games = computed(() => {
                    return [{{ games|raw }}].filter((game) => {
                        let none = game.unlocked_achievements === 0
                        let completed = !!game.completed_at
                        let wip = !(none || completed)
                        let result = false

                        if(listMode.value.includes('wip'))
                            result ||= wip
                        if(listMode.value.includes('none'))
                            result ||= none
                        if(listMode.value.includes('completed'))
                            result ||= completed

                        return result;
                    }).filter((b) => {
                        if (searchBox.value.length === 0)
                            return true
                        let searchValue = searchBox.value.toLowerCase()
                        let gameName = b.name.toLowerCase()
                        return gameName.includes(searchValue)
                    })
                })

                function highlight(name) {
                    if (searchBox.value.length === 0)
                        return name
                    return name ? name.replaceAll(new RegExp('(' + searchBox.value + ')', "ig"), '<span class="text-green-500">$1</span>') : '';
                }

                return {
                    games, listMode, searchBox, highlight, userId
                }
            }
        }).mount('#app')
    </script>
{% endblock %}
